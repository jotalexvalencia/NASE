<!DOCTYPE html>
<!-- =======================================================================
 * üìÑ asistencia.html ‚Äì Frontend de Reportes de Asistencia (NASE 2026)
 * ----------------------------------------------------------------------
 * @summary Dashboard de N√≥mina y Asistencia (Calculos de Horas).
 * @description 
 * Este archivo es la interfaz web para visualizar los datos generados por
 * `hoja_turnos.gs` (m√≥dulo `generarTablaAsistenciaSinValores`).
 * 
 * Muestra los turnos procesados por d√≠a, con el desglose de horas calculado:
 * - Horas Diurnas Normales.
 * - Horas Nocturnas Normales.
 * - Horas Diurnas Domingo/Festivo.
 * - Horas Nocturnas Domingo/Festivo.
 *
 * @features
 *   - üìä **Estad√≠sticas:** Contadores en tiempo real de Horas Totales, Nocturnas y Dominicales.
 *   - üìã **Tabla de Turnos:** Muestra una fila por turno trabajado por empleado.
 *   - üßÆ **Rango Visual:** Columna "Rango Turno" que muestra la fecha/hora completa
 *     (Ej: "24/12/2025 21:00 - 25/12/2025 05:00"). Esto ayuda a visualizar
 *     turnos que cruzan medianoche o abarcan varios d√≠as.
 *   - üíæ **Exportar CSV:** Descarga el reporte filtrado compatible con Excel.
 *
 * @dependencies
 *   - Backend: `hoja_turnos.gs` (Funciones `obtenerDataAsistencia`, `exportarAsistenciaCSV`).
 *   - Librer√≠as: Bootstrap 5 (Estilo), SweetAlert2 (Alertas).
 *
 * @author NASE Team
 * @version 1.1 (Visualizaci√≥n de Rangos)
 * ======================================================================= -->

<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>NASE - Consulta Asistencia</title> 
 
  <!-- Bootstrap + Fonts + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
 
  <!-- ======================================================================
   * üé® ESTILOS CSS (Dise√±o Visual)
   * ====================================================================== -->
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #fff;
      --primary: #0b6efd;
      --success: #198754;
      --text-color: #17365D;
    }
   
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Poppins', Arial, Helvetica, sans-serif;
      background-color: var(--bg);
      font-size: 0.875rem;
    }
   
    /* Contenedor Principal */
    .app-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
   
    /* Cabecera */
    .header {
      background: var(--card);
      padding: 15px 30px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    .logo { height: 80px; }
    .page-title {
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.5rem;
      margin: 0;
      text-align: center;
      flex-grow: 1;
      padding: 0 20px;
    }
   
    /* Tarjeta de Filtros */
    .filters-card {
      background: var(--card);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #f0f0f0;
    }
   
    /* Inputs y Selects */
    .form-label {
      font-weight: 600;
      color: var(--text-color);
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }
   
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      font-size: 0.9rem;
    }
   
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11,110,253,0.15);
    }
   
    /* Botones Personalizados */
    .btn-custom {
      min-height: 46px;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 10px;
      padding: 8px 20px;
      transition: all 0.2s;
    }
   
    .btn-primary-custom {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
   
    .btn-primary-custom:hover {
      background-color: #0a58ca;
      border-color: #0a58ca;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(11,110,253,0.25);
    }
   
    .btn-success-custom {
      background-color: var(--success);
      border-color: var(--success);
      color: white;
    }
   
    .btn-success-custom:hover {
      background-color: #157347;
      border-color: #157347;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(25,135,84,0.25);
    }
   
    /* Contenedor de Tabla con Scroll y Encabezado Fijo */
    .table-container {
      max-height: 600px;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
      transform: none !important;
      filter: none !important;
      will-change: auto !important;
    }

    .table {
      width: 100%;
      min-width: 1400px; /* Ancho m√≠nimo ajustado para mostrar fechas largas de rango */
      border-collapse: collapse;
    }

    /* Encabezado Sticky */
    .table thead th {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #f8f9fa;
      background-clip: padding-box;
      color: var(--text-color);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid #dee2e6;
      padding: 10px;
      white-space: nowrap;
    }

    .table tbody td {
      padding: 10px;
      vertical-align: middle;
      font-size: 0.85rem;
      border: 1px solid #f1f3f5;
      white-space: nowrap;
    }
   
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
   
    /* Helper para centrar celdas espec√≠ficas */
    .text-center-cell {
      text-align: center !important;
    }
   
    /* Cajas de Estad√≠sticas */
    .stats-box {
      background: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      height: 100%;
    }
    .stats-num { font-size: 1.6rem; font-weight: 600; color: var(--text-color); line-height: 1.2; }
    .stats-label { color: #6c757d; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }
   
    /* Autocomplete (Sugerencias) */
    .autocomplete-suggestions {
      position: absolute;
      border: 1px solid #ddd;
      background: white;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
    }
    .autocomplete-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-suggestion:hover {
      background-color: #f8f9fa;
    }
    .autocomplete-suggestion:last-child {
      border-bottom: none;
    }
   
    /* Ajustes Responsivos */
    @media (max-width: 768px) {
      .app-container { padding: 10px; }
      .header { padding: 10px 15px; }
      .page-title { font-size: 1.2rem; }
      .logo { height: 60px; }
      .filters-card, .table-container { padding: 15px; }
      .table thead th, .table tbody td { padding: 8px 6px; font-size: 12px; }
    }
  </style>
</head>


<!-- ======================================================================
 * üìê ESTRUCTURA HTML (DOM)
 * ====================================================================== -->
<body>
  <div class="app-container">
    <!-- 1. CABECERA -->
    <div class="header">
      <img src="https://raw.githubusercontent.com/jotalexvalencia/NASE/main/Logo_Nase.png" alt="NASE" class="logo">
      <h2 class="page-title">Consulta Registro de Asistencia</h2>
      <div style="width: 80px;"></div>
    </div>
   
    <!-- 2. üìä TARJETA DE ESTAD√çSTICAS (Contadores) -->
    <!-- Muestra totales: Registros, Horas Totales, Horas Nocturnas, Horas Domingo -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num" id="statRegistros">0</div>
          <div class="stats-label">Registros</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num text-primary" id="statHorasTotal">0</div>
          <div class="stats-label">Horas Totales</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num text-dark" id="statHorasNoc">0</div>
          <div class="stats-label">Horas con Recargo (Noc)</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num text-warning" id="statHorasFest">0</div>
          <div class="stats-label">Horas Dominicales</div>
        </div>
      </div>
    </div>
   
    <!-- 3. TARJETA DE FILTROS -->
    <div class="filters-card">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Fecha Inicio</label>
          <input type="date" id="filtroFechaInicio" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha Fin</label>
          <input type="date" id="filtroFechaFin" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">C√©dula</label>
          <input type="text" id="filtroCedula" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('cedula')">
          <!-- Div para sugerencias autocompletadas -->
          <div id="autocompleteCedula" class="autocomplete-suggestions"></div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Nombre</label>
          <input type="text" id="filtroNombre" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('nombre')">
          <div id="autocompleteNombre" class="autocomplete-suggestions"></div>
        </div>
        
        <!-- Filtro Tipo D√≠a (Normal, Domingo, Festivo) -->
        <div class="col-md-2">
          <label class="form-label">Tipo D√≠a</label>
          <select id="filtroTipoDia" class="form-select">
            <option value="">Todos</option>
            <option value="Normal">Normal</option>
            <option value="Domingo">Domingo</option>
            <option value="Festivo">Festivo</option>
          </select>
        </div>
        <div class="col-md-12 d-flex justify-content-end mt-3 gap-2">
          <button class="btn btn-custom btn-primary-custom" onclick="cargarDatosServidor()">
            <i class="bi bi-search me-2"></i>Consultar
          </button>
          <button class="btn btn-custom btn-success-custom" onclick="exportarDatos()">
            <i class="bi bi-file-earmark-excel me-2"></i>Exportar
          </button>
        </div>
      </div>
    </div>
   
    <!-- 4. TABLA DE REGISTROS (Con Scroll y Encabezado Sticky) -->
    <!-- Nota: Min-width ajustado para acomodar columna "Rango Turno" con fechas largas -->
    <div class="table-container">
      <table class="table" id="tablaRegistros">
        <thead>
          <tr>
            <th>C√©dula</th>
            <th>Nombre Empleado</th>
            <th>Fecha</th>
            <!-- Columna "Rango Turno & Centro" muestra el rango completo y el nombre del centro -->
            <th>Rango Turno & Centro</th>
            <th>Tipo D√≠a<br><small>(Inicio / Fin)</small></th>
            <th>TOTAL<br>HORAS</th>
            <th>Turno<br>Diurno</th>
            <th>Turno<br>Nocturno</th>
            <th>Dominical<br>Diurno</th>
            <th>Dominical<br>Nocturno</th>
          </tr>
        </thead>
        <tbody id="cuerpoTabla">
          <!-- Spinner de carga inicial -->
          <tr>
            <td colspan="11" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <div class="mt-2 text-muted">Cargando datos...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
   
    <!-- 5. PAGINACI√ìN -->
    <div class="pagination-container">
      <ul class="pagination" id="paginacion"></ul>
    </div>
  </div>


<!-- ======================================================================
 * üß† L√ìGICA JAVASCRIPT (Frontend)
 * ====================================================================== -->
  <script>
    /**
     * @summary Variables Globales de Estado.
     * @description Almacenan los datos descargados y el estado de la paginaci√≥n.
     */
    let registrosData = []; // Array con todos los turnos procesados (del backend)
    let paginaActual = 1;
    const registrosPorPagina = 8;


    // Variables para manejo de autocompletado
    let autocompleteTimeout = null;
    let selectedAutocomplete = null;

    // -------------------------------------------------------------------
    // 1. INICIALIZACI√ìN
    // -------------------------------------------------------------------
    /**
     * @summary Al cargar la p√°gina, establece fechas por defecto y carga datos.
     */
    document.addEventListener('DOMContentLoaded', function() {
      const hoy = new Date();
      // Primer d√≠a del mes actual
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      // Primer d√≠a del mes siguiente (√∫ltimo del actual + 1, luego 0)
      const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);

      // Establecer inputs de fecha (formato YYYY-MM-DD para input date)
      document.getElementById('filtroFechaInicio').value = primerDiaMes.toISOString().split('T')[0];
      document.getElementById('filtroFechaFin').value = ultimoDiaMes.toISOString().split('T')[0];

      // Cargar primera vez
      cargarDatosServidor();
    });

    // -------------------------------------------------------------------
    // 2. OBTENER DATOS (Backend Interaction)
    // -------------------------------------------------------------------
    /**
     * @summary Solicita datos de asistencia al servidor.
     * @description Llama a `obtenerDataAsistencia` en `hoja_turnos.gs`.
     *              Permite filtrar por rango de fechas, C√©dula, Nombre y Tipo D√≠a.
     */
    function cargarDatosServidor() {
      // Recoger filtros del DOM
      const filtros = {
        fechaInicio: document.getElementById('filtroFechaInicio').value,
        fechaFin: document.getElementById('filtroFechaFin').value,
        cedula: document.getElementById('filtroCedula').value,
        nombre: document.getElementById('filtroNombre').value,
        tipoDia: document.getElementById('filtroTipoDia').value
      };

      // Mostrar spinner en la tabla
      document.getElementById('cuerpoTabla').innerHTML = `
        <tr><td colspan="11" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2 text-muted">Cargando...</div>
        </td></tr>
      `;

      // Llamada al backend
      google.script.run
        .withSuccessHandler(function(res) {
          if (res.status === 'ok') {
            registrosData = res.registros || [];
            
            // Aplicar filtro local de tipo d√≠a (si no se filtr√≥ en backend o para optimizar UI)
            if (filtros.tipoDia) {
              registrosData = registrosData.filter(r => r.tipoDiaInicio === filtros.tipoDia || r.tipoDiaFin === filtros.tipoDia);
            }
            
            paginaActual = 1;
            mostrarRegistros();
            actualizarEstadisticas();
          } else {
            document.getElementById('cuerpoTabla').innerHTML = `
              <tr><td colspan="11" class="text-center text-danger py-5">
                ${res.message || 'Error desconocido al cargar datos'}
              </td></tr>`;
            resetEstadisticas();
          }
        })
        .withFailureHandler(function(err) {
          document.getElementById('cuerpoTabla').innerHTML = `
            <tr><td colspan="11" class="text-center text-danger py-5">
              Error: ${err.message || 'No se pudo conectar al servidor'}
            </td></tr>`;
          resetEstadisticas();
        })
        .obtenerDataAsistencia(filtros);
    }

    /**
     * @summary Resetea los contadores de estad√≠sticas a 0.
     */
    function resetEstadisticas() {
      document.getElementById('statRegistros').textContent = '0';
      document.getElementById('statHorasTotal').textContent = '0';
      document.getElementById('statHorasNoc').textContent = '0';
      document.getElementById('statHorasFest').textContent = '0';
    }

    // -------------------------------------------------------------------
    // 3. ESTAD√çSTICAS
    // -------------------------------------------------------------------
    /**
     * @summary Calcula y muestra los totales en las cajas de estad√≠sticas.
     * @description Suma las columnas de horas de todos los registros filtrados.
     *              - Total: Suma de todas las horas.
     *              - Noc: Suma de Diurnas Nocturnas + Domingo Nocturnas.
     *              - Fest: Suma de Diurnas Dominicales + Nocturnas Dominicales.
     */
    function actualizarEstadisticas() {
      const total = registrosData.length;
      
      // Sumar horas usando reduce
      const totalHoras = registrosData.reduce((a,b) => a + b.horasTotal, 0);
      const horasNoc = registrosData.reduce((a,b) => a + b.hNocNorm + b.hNocFest, 0);
      const horasFest = registrosData.reduce((a,b) => a + b.hDiurFest + b.hNocFest, 0);
      
      document.getElementById('statRegistros').textContent = total;
      document.getElementById('statHorasTotal').textContent = totalHoras.toFixed(1);
      document.getElementById('statHorasNoc').textContent = horasNoc.toFixed(1);
      document.getElementById('statHorasFest').textContent = horasFest.toFixed(1);
    }

    // -------------------------------------------------------------------
    // 4. RENDERIZADO DE TABLA
    // -------------------------------------------------------------------
    /**
     * @summary Renderiza la tabla de asistencia por p√°ginas.
     * @description
     *      - Muestra C√©dula, Nombre, Fecha y la columna especial "Rango Turno".
     *      - La columna "Rango Turno" muestra `r.turnosDetalle` que viene del backend
     *        con el formato "dd/mm/aaaa HH:mm - dd/mm/aaaa HH:mm".
     *      - Muestra las 4 columnas de horas calculadas.
     */
    function mostrarRegistros() {
      const tbody = document.getElementById('cuerpoTabla');
      if (!registrosData.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="text-center py-5">No se encontraron registros</td></tr>`;
        document.getElementById('paginacion').innerHTML = '';
        return;
      }

      // Paginaci√≥n: Cortar array `registrosData` seg√∫n p√°gina actual
      const inicio = (paginaActual - 1) * registrosPorPagina;
      const fin = inicio + registrosPorPagina;
      const pagina = registrosData.slice(inicio, fin);
      tbody.innerHTML = '';

      // Iterar sobre los registros de la p√°gina actual
      pagina.forEach(r => {
        const row = `
          <tr>
            <td class="fw-bold text-center-cell">${r.cedula}</td>
            <td>${r.nombre}</td>
            <td class="text-center-cell">${formatearFechaSeguro(r.fecha)}</td>
            <!-- ‚úÖ Columna Visual Rango: Usa 'turnosDetalle' (Ej: "24/12/2025 21:00 - 25/12/2025 05:00") -->
            <td class="text-center-cell small">
                <div>${r.turnosDetalle}</div>
                <strong style="color:#0b6efd; display:block; margin-top:4px;">${r.centro}</strong>
            </td>
            <td class="text-center-cell small">
              <div class="fw-bold">${r.tipoDiaInicio}</div>
              <div class="text-muted" style="font-size:0.7em">a</div>
              <div class="fw-bold">${r.tipoDiaFin}</div>
            </td>
            <td class="text-center-cell">${r.horasTotal}</td>
            <td class="text-center-cell">${r.hDiurNorm}</td>
            <td class="text-center-cell">${r.hNocNorm}</td>
            <td class="text-center-cell">${r.hDiurFest}</td>
            <td class="text-center-cell">${r.hNocFest}</td>
          </tr>`;
        tbody.innerHTML += row;
      });

      actualizarPaginacion();
    }

    // -------------------------------------------------------------------
    // 5. PAGINACI√ìN (L√≥gica Visual)
    // -------------------------------------------------------------------
    function actualizarPaginacion() {
      const total = Math.ceil(registrosData.length / registrosPorPagina);
      const ul = document.getElementById('paginacion');
      ul.innerHTML = '';

      // Bot√≥n Anterior
      const prev = document.createElement('li');
      prev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
      prev.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})">&laquo;</a>`;
      ul.appendChild(prev);

      // Botones Num√©ricos
      for (let i = 1; i <= total; i++) {
        // L√≥gica de puntos suspensivos (...) si hay muchas p√°ginas
        if (total <= 7 || (i === 1 || i === total || (i >= paginaActual - 1 && i <= paginaActual + 1))) {
          const li = document.createElement('li');
          li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a>`;
          ul.appendChild(li);
        } else if ((i === paginaActual - 2 || i === paginaActual + 2) && total > 7) {
          const li = document.createElement('li');
          li.className = 'page-item disabled';
          li.innerHTML = '<a class="page-link">...</a>';
          ul.appendChild(li);
        }
      }

      // Bot√≥n Siguiente
      const next = document.createElement('li');
      next.className = `page-item ${paginaActual === total ? 'disabled' : ''}`;
      next.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})">&raquo;</a>`;
      ul.appendChild(next);
    }

    function cambiarPagina(p) {
      const max = Math.ceil(registrosData.length / registrosPorPagina);
      if (p < 1 || p > max) return;
      paginaActual = p;
      mostrarRegistros();
    }

    // -------------------------------------------------------------------
    // 6. EXPORTAR A CSV
    // -------------------------------------------------------------------
    /**
     * @summary Descarga el reporte filtrado en formato CSV.
     * @description Llama a `exportarAsistenciaCSV` en el backend, recibe el string CSV
     *              y crea un Blob para descargarlo en el navegador.
     */
        function exportarDatos() {
      // Obtener filtros actuales
      const filtros = {
        fechaInicio: document.getElementById('filtroFechaInicio').value,
        fechaFin: document.getElementById('filtroFechaFin').value,
        cedula: document.getElementById('filtroCedula').value,
        nombre: document.getElementById('filtroNombre').value,
        tipoDia: document.getElementById('filtroTipoDia').value // <--- ‚úÖ ESTA ES LA L√çNEA QUE FALTABA
      };

      // Mostrar SweetAlert de carga
      Swal.fire({ title: 'Exportando...', didOpen: () => Swal.showLoading() });

      google.script.run
        .withSuccessHandler(function(res) {
          Swal.close();
          if (res.status === 'ok') {
            // Crear Blob con BOM UTF-8 para que Excel abra bien los acentos
            const blob = new Blob(["\ufeff", res.csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = res.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            Swal.fire('√âxito', 'Archivo descargado.', 'success');
          } else {
            Swal.fire('Error', res.message || 'Error al exportar.', 'error');
          }
        })
        .withFailureHandler(function(err) {
          Swal.close();
          Swal.fire('Error', err.message, 'error');
        })
        .exportarAsistenciaCSV(filtros);
    }

    // -------------------------------------------------------------------
    // 7. AUTOCOMPLETADO (Sugerencias de B√∫squeda)
    // -------------------------------------------------------------------
    /**
     * @summary Busca sugerencias de C√©dula o Nombre en el backend.
     * @description Muestra un dropdown con coincidencias mientras el usuario escribe.
     */
    function buscarAutocomplete(tipo) {
      clearTimeout(autocompleteTimeout);
      const input = document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
      const suggestionsDiv = document.getElementById(`autocomplete${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
      const valor = input.value.trim();

      if (valor.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      // Debounce: Esperar 300ms despu√©s de que el usuario deje de escribir
      autocompleteTimeout = setTimeout(() => {
        google.script.run
          .withSuccessHandler(suggestions => {
            if (suggestions && suggestions.length > 0) {
              suggestionsDiv.innerHTML = suggestions.map(s => `
                <div class="autocomplete-suggestion" onclick="seleccionarSugerencia('${tipo}', '${s}')">${s}</div>
              `).join('');
              suggestionsDiv.style.display = 'block';
            } else {
              suggestionsDiv.style.display = 'none';
            }
          })
          .withFailureHandler(() => {
            suggestionsDiv.style.display = 'none';
          })
          .obtenerSugerencias(valor, tipo);
      }, 300);
    }

    /**
     * @summary Selecciona una sugerencia y filtra.
     */
    function seleccionarSugerencia(tipo, valor) {
      document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = valor;
      document.getElementById(`autocomplete${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'none';
      cargarDatosServidor(); // Volver a filtrar con el nuevo valor
    }

    /**
     * @summary Cierra los dropdowns si se hace clic fuera.
     */
    document.addEventListener('click', function(e) {
      const inputs = ['filtroCedula', 'filtroNombre'];
      const suggestions = ['autocompleteCedula', 'autocompleteNombre'];
      
      // Si el clic no fue dentro de un input, cerrar todos los dropdowns
      if (!inputs.some(id => e.target.id === id)) {
        suggestions.forEach(id => {
          document.getElementById(id).style.display = 'none';
        });
      }
    });
        /**
     * @summary Formatea fecha de forma segura para evitar errores MM/DD.
     * @description Si el backend env√≠a String (dd/mm/yyyy), lo mantiene. 
     *              Si env√≠a Date u Objeto, lo formatea.
     */
    function formatearFechaSeguro(inputDate) {
      if (!inputDate) return '-';
      const str = String(inputDate);

      // Si el dato ya es texto con formato fecha (ej: "02/01/2026"), devolverlo tal cual
      // Esto evita que el navegador lo interprete mal como MM/DD
      if (str.length === 10 && str.includes('/')) {
        return str;
      }

      try {
        const date = new Date(inputDate);
        if (isNaN(date.getTime())) return str;
        const dia = String(date.getDate()).padStart(2, '0');
        const mes = String(date.getMonth() + 1).padStart(2, '0');
        const anio = date.getFullYear();
        return `${dia}/${mes}/${anio}`;
      } catch (e) {
        return '-';
      }
    }
  </script>
</body>
</html>
